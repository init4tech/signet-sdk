use alloy::{
    consensus::{constants::GWEI_TO_WEI, ReceiptEnvelope, Sealed},
    primitives::{address, Address, B256, U256},
};
use signet_constants::{pecorino::DEPLOY_HEIGHT, SignetSystemConstants};
use signet_extract::Extractor;
use signet_test_utils::{
    chain::Chain,
    specs::{HostBlockSpec, RuBlockSpec},
    test_constants::*,
    users::*,
};
use signet_types::primitives::{
    BlockBody, SealedBlock, SealedHeader, Transaction, TransactionSigned,
};

#[test]
fn extraction() {
    let mut ru_block =
        RuBlockSpec::test().with_gas_limit(12345).with_reward_address(Address::repeat_byte(0x99));
    ru_block.add_simple_send(&TEST_SIGNERS[0], TEST_USERS[1], U256::from(GWEI_TO_WEI), 0);

    let hbs = HostBlockSpec::test()
        .with_block_number(1)
        .enter(TEST_USERS[0], (GWEI_TO_WEI * 4) as usize)
        .enter(TEST_USERS[1], (GWEI_TO_WEI * 2) as usize)
        .enter_token(TEST_USERS[2], 10_000_000, HOST_USDC)
        .simple_transact(TEST_USERS[0], TEST_USERS[4], [1, 2, 3, 4], GWEI_TO_WEI as usize)
        .fill(HOST_USDT, TEST_USERS[4], 10_000)
        .submit_block(ru_block);
    let (chain, _) = hbs.to_chain();

    let extractor = Extractor::new(TEST_SYS);
    let extracts = extractor.extract_signet(&chain).next().unwrap();

    hbs.assert_conforms(&extracts);
}

#[test]
fn test_that_order() {
    let receipt: ReceiptEnvelope = serde_json::from_str(RECEIPT_JSON).unwrap();
    let tx: TransactionSigned = serde_json::from_str(TX_JSON).unwrap();
    let header: alloy::consensus::Header = serde_json::from_str(HEADER_JSON).unwrap();
    let header = SealedHeader::new(header);

    let block = signet_types::primitives::RecoveredBlock {
        block: SealedBlock {
            header,
            body: BlockBody { transactions: vec![tx], ommers: vec![], withdrawals: None },
        },
        senders: vec![address!("0xaf01ca2f03ece0e4ee210961ba5ac1035346441a")],
    };

    let execution_outcome =
        signet_evm::ExecutionOutcome::new(Default::default(), vec![vec![receipt.clone()]], 0);

    let chain = Chain { blocks: vec![block], execution_outcome };

    let extractor = Extractor::from(SignetSystemConstants::pecorino());

    let extracts = extractor.extract_signet(&chain).next().unwrap();
    dbg!(&extracts.aggregate_fills());
}

const TX_JSON: &str = r#"{"hash":"0x457cd332751195cacaf4e652955067d752558b96dc98ec71a484c35fa8a35ed0","nonce":"0x173e0","blockHash":"0x772a9aedae4ecb1d1aec06f01c084909fc6e345e9828f4666a9259216e40eab8","blockNumber":"0xe991a","transactionIndex":"0x0","from":"0xaf01ca2f03ece0e4ee210961ba5ac1035346441a","to":"0xb393416a722fd48c3b0a9ab5fc2512ef0c55e4ca","value":"0x0","gasPrice":"0x77359407","gas":"0x2025f","maxFeePerGas":"0x77359407","maxPriorityFeePerGas":"0x77359400","maxFeePerBlobGas":"0x1","input":"0x628db5210000000000000000000000000000000000000000000000000000000000000120000000000000000000000000000000000000000000000000000000000000375e00000000000000000000000000000000000000000000000000000000000e991a0000000000000000000000000000000000000000000000000000000001c9c380000000000000000000000000ecb32705b0b647dcd6cd6b79b80bfd03cdf0ac3d564666b416bde126e093124872b3dd493428650efd0228e49356026083dc376c000000000000000000000000000000000000000000000000000000000000001b3d07726f0f99c10f9ae6ac2aa86c02d05828aac6564fa00b322dbf7c8b49afaf7e2d2274e83d6ce0a16fb35c7a41b86340630f782f40f2905938aefcfd747c6900000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000001000000000000000000000000885f8db528dc8a38aa3ddad9d3f619746b4a6a8100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000492e9c316f073fe4de9d665221568cdad1a7e95b00000000000000000000000000000000000000000000000000000000003018240000000000000000000000000000000000000000000000000000000000000060000000000000000000000000492e9c316f073fe4de9d665221568cdad1a7e95b000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000006399504b37b2a00000000000000000000000000000000000000000000000000000000686fe15a0000000000000000000000000000000000000000000000000000000000000001000000000000000000000000885f8db528dc8a38aa3ddad9d3f619746b4a6a8100000000000000000000000000000000000000000000000000000000000f424000000000000000000000000000000000000000000000000000000000000000419d0b799ef1d3f3df8d66bf98436c027d82baa6d10227e903b35be2df35caa1514b7d6ebc8295817a0bab59fba1bd4d4cc87c9b09710b61e716147229d10de8f81b00000000000000000000000000000000000000000000000000000000000000","r":"0xa53cd845540c149af0ffe6f71cb9475d211a830d8d4c59993f06bb986d10a2ad","s":"0xd20cdd09aac9fb61b8e5fcb05010ce09cc1b3cb2cefdb10b26ba8c755899442","v":"0x0","yParity":"0x0","chainId":"0x301824","blobVersionedHashes":["0x011e45d2ef32b3010a66dee4ec7ed2597a05cd71f34ec6323566647958fbb880"],"accessList":[],"type":"0x3"}
"#;

const RECEIPT_JSON: &str = r#"{"status":"0x1","cumulativeGasUsed":"0x1f449","logs":[{"address":"0x885f8db528dc8a38aa3ddad9d3f619746b4a6a81","topics":["0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef","0x000000000000000000000000492e9c316f073fe4de9d665221568cdad1a7e95b","0x000000000000000000000000492e9c316f073fe4de9d665221568cdad1a7e95b"],"data":"0x00000000000000000000000000000000000000000000000000000000000f4240","blockHash":"0x772a9aedae4ecb1d1aec06f01c084909fc6e345e9828f4666a9259216e40eab8","blockNumber":"0xe991a","blockTimestamp":"0x686fdf10","transactionHash":"0x457cd332751195cacaf4e652955067d752558b96dc98ec71a484c35fa8a35ed0","transactionIndex":"0x0","logIndex":"0x0","removed":false},{"address":"0x4e8cc181805afc307c83298242271142b8e2f249","topics":["0x14b3027353aba71f468d178fdede9ac211a25ae484028823bce1e6700e58e624"],"data":"0x00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000001000000000000000000000000885f8db528dc8a38aa3ddad9d3f619746b4a6a8100000000000000000000000000000000000000000000000000000000000f4240000000000000000000000000492e9c316f073fe4de9d665221568cdad1a7e95b0000000000000000000000000000000000000000000000000000000000301824","blockHash":"0x772a9aedae4ecb1d1aec06f01c084909fc6e345e9828f4666a9259216e40eab8","blockNumber":"0xe991a","blockTimestamp":"0x686fdf10","transactionHash":"0x457cd332751195cacaf4e652955067d752558b96dc98ec71a484c35fa8a35ed0","transactionIndex":"0x0","logIndex":"0x1","removed":false},{"address":"0xbe45611502116387211d28ce493d6fb3d192bc4e","topics":["0xfe642e465ceaeb1c7f4cedaee76e84b12970fe1546683f8758525b3a0e2b4442","0x000000000000000000000000d554a80a682e2384cd5582b3d6e72b01fa685031","0x000000000000000000000000000000000000000000000000000000000000375e"],"data":"0x0000000000000000000000000000000000000000000000000000000001c9c380000000000000000000000000ecb32705b0b647dcd6cd6b79b80bfd03cdf0ac3d564666b416bde126e093124872b3dd493428650efd0228e49356026083dc376c","blockHash":"0x772a9aedae4ecb1d1aec06f01c084909fc6e345e9828f4666a9259216e40eab8","blockNumber":"0xe991a","blockTimestamp":"0x686fdf10","transactionHash":"0x457cd332751195cacaf4e652955067d752558b96dc98ec71a484c35fa8a35ed0","transactionIndex":"0x0","logIndex":"0x2","removed":false}],"logsBloom":"0x00000200100200000000000040000000000000000000000001000000000000000000000008000000080000000000000000000000000000000000000000004000000000000000000000000008000000000001000000000000000800000000000000000000000000000000000000000000002000000000000020000010000000000000000000000000000202000000000000000000000010000000000000000000000000000000000000000000000000000000000000000008000009000000004000000002000000000000000000000000000000000400000080000000000000000008000000000000000000000100000000000000001000000000000000000000","type":"0x3","transactionHash":"0x457cd332751195cacaf4e652955067d752558b96dc98ec71a484c35fa8a35ed0","transactionIndex":"0x0","blockHash":"0x772a9aedae4ecb1d1aec06f01c084909fc6e345e9828f4666a9259216e40eab8","blockNumber":"0xe991a","gasUsed":"0x1f449","effectiveGasPrice":"0x77359407","blobGasUsed":"0x20000","blobGasPrice":"0x1","from":"0xaf01ca2f03ece0e4ee210961ba5ac1035346441a","to":"0xb393416a722fd48c3b0a9ab5fc2512ef0c55e4ca","contractAddress":null}
    "#;

const HEADER_JSON: &str = r#"{"hash":"0x772a9aedae4ecb1d1aec06f01c084909fc6e345e9828f4666a9259216e40eab8","parentHash":"0xe2b9b9bff8e11f78b99b139b6b1c62a2ef27e4c31c4316700a0e34b35cae4c9b","sha3Uncles":"0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347","miner":"0x8943545177806ed17b9f23f0a21ee5948ecaa776","stateRoot":"0x82c31dd33c3e30212f5eddef1d3e4bbdd14d62458a84106603a4212fd5e69c3d","transactionsRoot":"0xe8994ef7835eab75f63b64f1d393468f4992c983b414ab0b14206c22fe706b99","receiptsRoot":"0x3adbf927851a51b09568f5c25dafd6706cf768d4d25fa6007c5caf9075de8e37","logsBloom":"0x00000200100200000000000040000000000000000000000001000000000000000000000008000000080000000000000000000000000000000000000000004000000000000000000000000008000000000001000000000000000800000000000000000000000000000000000000000000002000000000000020000010000000000000000000000000000202000000000000000000000010000000000000000000000000000000000000000000000000000000000000000008000009000000004000000002000000000000000000000000000000000400000080000000000000000008000000000000000000000100000000000000001000000000000000000000","difficulty":"0x0","number":"0xe991a","gasLimit":"0x2255100","gasUsed":"0x1f449","timestamp":"0x686fdf10","extraData":"0x726574682f76312e322e302f6c696e7578","mixHash":"0xbe4d787325517aaecb4b7e74f519cc89c818b00884556179c8c70b8c78befe20","nonce":"0x0000000000000000","baseFeePerGas":"0x7","withdrawalsRoot":"0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421","blobGasUsed":"0x20000","excessBlobGas":"0x0","parentBeaconBlockRoot":"0x281738dee03cf8118b8135d4c61667cbd5f8aef17d3f2e282af00c9206360222","uncles":[],"transactions":["0x457cd332751195cacaf4e652955067d752558b96dc98ec71a484c35fa8a35ed0"],"size":"0x6e0","withdrawals":[]}
"#;
